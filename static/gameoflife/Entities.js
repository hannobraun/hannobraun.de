(function(){function a(){this._dataStructureConstructors={},this._entities={},this._nextId=0}a.NO_SUCH_ENTITY_MESSAGE="No such entity: ",a.INVALID_ENTITY_MESSAGE="What you passed as an the entity object appears to be an entity builder instead. This happens when\nyou use buildEntity() to create an entity, but forget to call create().\nMake sure you called the create method at the end, like this: buildEntity().withComponent( ... ).create()",a.prototype.setDataStructureFor=function(a,b){this._dataStructureConstructors[a]=b},a.prototype.prepareQuery=function(){},a.prototype.prepareQueryWithDefaults=function(){},a.prototype.create=function(b,c){if(c==undefined)var d=this._getNextId(),e=b;else var d=b,e=c;this._entities[d]=e.clone();if(e.__isEntityBuilder__)throw a.INVALID_ENTITY_MESSAGE;return d},a.prototype._getNextId=function(){var a=this._nextId;this._nextId+=1;return a},a.prototype.get=function(b){var c=this._entities[b];if(c==undefined)throw a.NO_SUCH_ENTITY_MESSAGE+b;return c},a.prototype.remove=function(a){delete this._entities[a]},a.prototype.returnEntitiesWith=function(a){var b=[];for(entityId in this._entities){var c=this._entities[entityId];this._entityHasAllComponents(c,a)&&b.push(entityId)}return b},a.prototype._entityHasAllComponents=function(a,b){var c=!0;for(var d=0;d<b.length;d++){var e=b[d];if(a[e]==undefined){c=!1;break}}return c},a.prototype.returnComponents=function(a){var b=this.returnEntitiesWith(a),c=[],d=this;a.forEach(function(a){c.push(d._getComponentsFromEntities(b,a))});return c},a.prototype.returnComponentsWithDefaults=function(a,b){var c=a.filter(function(a){return b[a]==undefined}),d=this.returnEntitiesWith(c),e=this,f=a.map(function(a){return d.map(function(c){var d=e._entities[c];return d[a]==undefined?b[a]:d[a]})});return f},a.prototype._getComponentsFromEntities=function(a,b){var c=this,d=c._dataStructureConstructors[b];if(d==undefined)var e=[];else var e=new d;a.forEach(function(a){e.push(c._entities[a][b])});return e},a.prototype.updateComponents=function(a,b){var c=this,d=c.returnEntitiesWith(a);a.forEach(function(a,e){d.forEach(function(d,f){c._entities[d][a]=b[e][f]})})},typeof window=="undefined"?module.exports=a:register("spell/common/core/Entities",a)})()